<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Speeding up spatial operations in R | Jacob T. Bradt</title> <meta name="author" content="Jacob T. Bradt"/> <meta name="description" content="Combining `sf` and `data.table` libraries to batch process spatial data in R"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="/assets/img/UT_favicon.png"/> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://jtbradt.github.io/blog/2022/spatialbatch/"> </head> <body class=" "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm sticky-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="https://jtbradt.github.io/"><span class="font-weight-bold">Jacob</span> T. Bradt</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Speeding up spatial operations in R</h1> <p class="post-meta">July 15, 2022</p> <p class="post-tags"> <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a> </p> </header> <article class="post-content"> <p>I am a <em>big</em> fan of R’s spatial libraries, especially <a href="https://cran.r-project.org/web/packages/sf/index.html" target="_blank" rel="noopener noreferrer">sf</a> for vector data and <a href="https://cran.r-project.org/web/packages/terra/index.html" target="_blank" rel="noopener noreferrer">terra</a> for raster data. In fact, I could write a great essay about the reasons why you should use R for your spatial analysis (it makes things easily replicable, it integrates well with other languages you might use in a project, it’s free, etc.), but I’ll leave that subtweet of ArcGIS for another day.</p> <p>For all of their magical features, I do sometimes find myself confronting non-trivial memory/timing barriers when using the R spatial libraries locally for my projects. This is particularly true when—as is often the case for me—I need to do things involving <a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html" target="_blank" rel="noopener noreferrer">geometric binary predicates</a> with many different geometries.</p> <p>One way that I’ve been getting around this recently is through batch processing. Making use of a pretty simple helper function from the <code class="language-plaintext highlighter-rouge">sf</code> package, <code class="language-plaintext highlighter-rouge">sf::st_make_grid()</code>, I can easily break up my spatial operations into more memory-manageable chunks.</p> <p>Say, for instance, I have a bunch of points for each of which I want to identify points falling a certain distance, say a mile. The sf package has a nice function for this: <code class="language-plaintext highlighter-rouge">sf::st_is_within_distance()</code>; however, if I have a lot of points using this function in the “standard” way would involve a non-trivial number of distance calculations (e.g., 10,000 points would mean 100,000,000 distance calculations!!). And most of those calculations are useless: I can easily rule out certain point-pairs as being outside of the target distance of say 1 mile.</p> <p>Let’s make this example a bit more concrete. Say we have 10,000 points within the state of California chosen at random. I can use the function <code class="language-plaintext highlighter-rouge">sf::st_make_grid()</code> to break up the spatial extent of this area into a specified number of grids (actually hexagons, but you can also do square grids — the hexagons fit spatial data a bit better). Once I’ve done that, I can make use of the <code class="language-plaintext highlighter-rouge">sf::st_join()</code> function to assign each of my points to a given grid, then I can loop over each grid when doing my intensive spatial operations.</p> <figure class="highlight"><pre><code class="language-r" data-lang="r"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td> <td class="code"><pre><span class="c1"># Load dependencies:</span><span class="w">
</span><span class="n">pacman</span><span class="o">::</span><span class="n">p_load</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span><span class="w"> </span><span class="n">tigris</span><span class="p">)</span><span class="w">

</span><span class="c1"># Download California county shapefiles:</span><span class="w">
</span><span class="n">ca.counties</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tigris</span><span class="o">::</span><span class="n">counties</span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"CA"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
	</span><span class="n">st_transform</span><span class="p">(</span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">crs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">st_crs</span><span class="p">(</span><span class="m">3310</span><span class="p">))</span><span class="w">
  
</span><span class="c1"># Sample points:</span><span class="w">
</span><span class="n">sample.points</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_sample</span><span class="p">(</span><span class="n">ca.counties</span><span class="p">,</span><span class="w"> </span><span class="m">10000</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
	</span><span class="n">st_sf</span><span class="w">
  
</span><span class="c1"># Create 10x10 grid:</span><span class="w">
</span><span class="n">ca.grid</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_make_grid</span><span class="p">(</span><span class="n">ca.state</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">10</span><span class="p">,</span><span class="m">10</span><span class="p">),</span><span class="w"> </span><span class="n">square</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
	</span><span class="n">st_sf</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>The <code class="language-plaintext highlighter-rouge">square=F</code> argument makes a grid of hexagons with the same extent of the California county polygons. Now if you’re paying close attention, you might worry about how points at the edges of each grid are handled with this approach. Surely there might be some points falling within the target distance for points on the boundary of a given grid that are in other grids. To get around this, we can actually buffer the grid polygons we’ve created by the target distance—here I’m using a mile—and <em>then</em> do the <code class="language-plaintext highlighter-rouge">st_join()</code> with our points:</p> <figure class="highlight"><pre><code class="language-r" data-lang="r"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td> <td class="code"><pre><span class="c1"># Create one-mile buffer around CA grid:</span><span class="w">
</span><span class="n">ca.grid.buffer</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_buffer</span><span class="p">(</span><span class="n">ca.grid</span><span class="p">,</span><span class="w"> </span><span class="n">dist.within</span><span class="p">)</span><span class="w">

</span><span class="c1"># Intersect buffered grid with sampled points:</span><span class="w">
</span><span class="n">sample.points</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_join</span><span class="p">(</span><span class="n">sample.points</span><span class="p">,</span><span class="w"> </span><span class="n">ca.grid.buffer</span><span class="p">)</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>The side-by-side images below show the initial problem and the resulting batch assignments.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/fig_map_ca_nogrid-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/fig_map_ca_nogrid-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/fig_map_ca_nogrid-1400.webp"></source> <img src="/assets/img/fig_map_ca_nogrid.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> &lt;/div&gt; <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/fig_map_ca_grid-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/fig_map_ca_grid-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/fig_map_ca_grid-1400.webp"></source> <img src="/assets/img/fig_map_ca_grid.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> &lt;/div&gt; &lt;/div&gt; <div class="caption"> Assigning batches by spatial proximity to a random set of California points. </div> Now if I want to identify points falling within a mile of each point, I could just do a standard application of the `sf` package's `st_is_within_distance` function <figure class="highlight"><pre><code class="language-r" data-lang="r"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td> <td class="code"><pre><span class="c1"># Standard approach:</span><span class="w">
</span><span class="n">standard</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">microbenchmark</span><span class="p">(</span><span class="w">
	</span><span class="n">st_is_within_distance</span><span class="p">(</span><span class="n">sample.points</span><span class="p">,</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dist.within</span><span class="p">,</span><span class="w"> </span><span class="n">remove_self</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w">
</span><span class="p">)</span>
</pre></td> </tr></tbody></table></code></pre></figure> Again, if I have a lot of points (like 10,000 or more) this will quickly become difficult for my computer to handle. So I can instead batch process using data.table's magic: <figure class="highlight"><pre><code class="language-r" data-lang="r"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td> <td class="code"><pre><span class="c1"># Batch process:</span><span class="w">
</span><span class="n">batch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">microbenchmark</span><span class="p">(</span><span class="w">
	</span><span class="n">sample.points</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">.</span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">st_is_within_distance</span><span class="p">(</span><span class="n">.SD</span><span class="p">[[</span><span class="s1">'geometry'</span><span class="p">]],</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dist.within</span><span class="p">,</span><span class="w"> </span><span class="n">remove_self</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">))),</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">]</span><span class="w">
</span><span class="p">)</span>
</pre></td> </tr></tbody></table></code></pre></figure> What are the time savings? I did each of the above approaches for different numbers of points and it really does not take long for the batched approach to beat out the standard approach. <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/fig_spatial_batch-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/fig_spatial_batch-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/fig_spatial_batch-1400.webp"></source> <img src="/assets/img/fig_spatial_batch.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> &lt;/div&gt; &lt;/div&gt; For even larger problems, this opens up the possibility of parallel processing. The `sf::st_is_within_distance()` function is also not the most efficient of the sf packages offerings, so even greater speedups are likely possible for this particular use case. </figure> </div> </div></figure> </div></figure> </div> </div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2026 Jacob T. Bradt. Please send comments or questions to <a href="mailto:jacob.bradt@austin.utexas.edu">jacob.bradt@austin.utexas.edu</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js" integrity="sha256-l/1pMF/+J4TThfgARS6KwWrk/egwuVvhRzfLAMQ6Ds4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script src="/assets/js/zoom.js"></script> <script src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-7PE78WNPH6"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-7PE78WNPH6");</script> </body> </html>